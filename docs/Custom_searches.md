
# Creating a New Proactive Disclosure Search

## TL;DR - Quick Start ##

Custom Search definitions for Open Canada Search are made of number of components including
a database content files, python scripts, gettext portables, and HTML template snippets.

Before developing a custom search, be sure to set up and run the OC Search application: https://github.com/open-data/oc_search

These are the basic steps to create a new proactive disclosure search. Steps did not have to be
done in exactly this order.

- In the Django Admin interface create, create the database models that describe the Search. These
models include:
  - Search,
  - Fields, and
  - Codes
- Create a new Solr core and copy in the custom synonym files. As the Solr user run these commands
  ```bash
  /opt/solr/bin/solr create -c search_ati
  cd /var/solr/data
  cp -Rf search_ei/conf search_ati/
   ```
  Reload core the Solr core using the Solr Web Admin UI


- Customize the blank Solr core based on the search model using the `create_solr_core` command:

  ` python .\manage.py create_solr_core --search ati`

- _If required_ load the list of government departments using the `import_org_ckan_json` command.
- Create a code plug-in for the search that can contain python code for customizing the serach
- Load CSV data using the `import_data_csv` command.
- Create a snippets folder to hold Django template snaps to customize the appear of the search results page.
- Export the search definition (including all custom components) using the `export_search` command
- Import the search definition to another instance of Open Canada search using the `import_earch` command.

# Creating a New Proactive Disclosure Search

A custom search definition consists of a collection of files and information stored in the Search application database.
Most of the custom searches are published in on GitHub in project [oc_searches project]("https://github.com/open-data/oc_searches").

Creating a new custom search for proactive disclosure or other data requires multiple components to be created.
The development can be done locally in your development environment and then the custom search can be exported
as code and imported into another instance of Open Canada Search in a staging or production environment.

_Steps_:

1. Select a unique Search type ID.
1. Create a new blank Solr core and copy in the synonym configuration files.
1. Create a search model using the Django Admin web UI.
   - Create new fields associated with the new search model using the Django Admin web UI
   - Create new Codes associated with the new fields using Django web UI. (_optional_)
1. Apply the search model to the dynamic Solr core schema for the search model using the `create_solr_core` command
1. Create s code plug-in for the custom search. This plugin enables developers great flexibility to add custom logic and data handling to any custom search.
1. (_Optional_) Import the latest list of organization codes. Most but not all Open Government searches will require these codes.
1. Import the data from the proactive disclosure CSV file using the `import_data_csv` command
1. Create custom templates for the search
1. (_Optional_) Create custom Django management commands for any additional steps

## 1. Select a unique Search type ID ##

Select a unique Search type ID to use. This is a single unique identifier name. Typically, this name should be identical
to the [CKAN recombinant type code]("https://github.com/open-data/ckanext-canada/tree/master/ckanext/canada/tables").

For example: `contracts`, `qpnotes`, or `briefingt`.

## 2. Create a new Solr core ##

Using Solr 9.x, log onto your Solr VM or service, and as the `solr` user, create a new Solr core from the command line using the `solr` command.

Next, copy the custom synonyms files to the `lang` folder in the new Solr core's configuration folder. The synonyms files can be
found in the `oc_search/solr/conf` folder of this project, on [GitHub](https://github.com/open-data/oc_search/tree/master/oc_search/solr/conf). They can also be copied from an existing Solr search core.

Please note that the default `solrconfig.xml` file generated by the solr create command _does not_ need to be modified. By default,
the new Solr code will use Solr's dynamic API that allows the core's schema to be manipulated using code. By default the dynamic
API will apply these changes to the `managed-schema.xml` file.

By convention, the Solr core name uses the pattern `search_<recombinant type name>`. For example,
`search_contracts`, `search_qpnotes`, or `search_briefingt`.

*Example of creating new core from command line*:

```Shell
  sudo -u solr /opt/solr/bin/solr create -c search_qpnotes
  cp oc_search/solr/conf/synonyms_*.txt /var/solr/data/search_qpnotes/conf/lang/
```

After copying the synonym text files, use the Solr Admin UI,to _reload the new core_ in order to activate the new configuration files.

![Screenshot of using the Solr Admin UI to reload a Solr core.](./images/Reload-Solr-Core.png)

The core is now ready to be used by Search. In a future step, you will apply a custom search model to Solr.

*Note* this step may need to be repeated in the future when changes are made to the Search model. Often when changing s Solr
schema it can be necessary to rebuild the Solr core from scratch.

## 3. Create a New Search model with Fields and Codes ##

The search model consists of three database components:
- search,
- fields which always associated with a given search, and
- codes (_optional_) which are always associated with a given field.

Codes can be regular codes, or Chronologic Codes which are codes that are associated with a date range.
Regular Codes can be used in almost all cases.

![Image of the 3 database components of a search definition](./images/db-model.png)

Begin by creating a new search model using the Django admin UI. If you do not already have a Django admin
account, create one using the Djagno command-line tool.

```Shell
  python .\manage.py createsuperuser --username <new account name> --email <email address>
```

### 3.1 New Search Record ###

First create a Search record, by clicking on the Search type in the Django Administration menu.

Then click the "*Add search*" button. Use the multi-tab interface to edit the Search record's
fields. Complete the form as needed, then click the _Save_ button. Mandatory fields are indicated with an
asterisk.

![Screenhot of the Django Admin Search object menu item](./images/admin-ui-search-model.png)


#### General Tab

| *Field* | *Description* | *Example Value* |
| --------| ------------- | --------------- |
| Search ID  | Unique Search object identifier | contracts |
| Solr Core Name | Name of the core on the Solr service | search_contracts |
| Solr debugging | Enabled Solr debugging in response. Normally should be disabled |  |
| Unique ID Identifier | The field(s) that form the primary key. For compound keys, separate fields with commands | owner_org,ref_number |
| Alternate Record Format | Searches may contain a secondary data format, like Nothing-To-Report. Provide an identifier | NTR |
| Search Title (English) | English Page Title | "Search Government Contracts over $10,000" |
| Search Title (French) | French Page Title | "Recherche des contrats gouvernementaux de plus de 10 000 $" |
| Download Dataset Link Text (English) | Text for the link to the CKAN dataset page | "Dataset Page" |
| Download Dataset URL (English) | The link to the CKAN dataset page | "https://open.canada.ca/data/en/dataset/c4c5c7f1-bfa6-4ff6-b4a0-c164cb2060f7" |
| Download Dataset Link Text (Français) | French text for the link to the CKAN dataset page | "Ensemble de données"  |
| Download Dataset URL (French) | The link to the French CKAN dataset page | "https://open.canada.ca/data/en/dataset/c4c5c7f1-bfa6-4ff6-b4a0-c164cb2060f7" |
| Description (English) | Optional brief description of the Search |  |
| Description (Français)  | Optional brief French description of the Search | "Search for stuff" |
| About the search message (English) | Text for the "About this Information" section on the Search page | "This search..." |
| About the search message (Français) | French test for the "About this Information" section on the Search page  | "À propos de cette recherche..." |
| Search alias (English)  | An English readable name to use in the search url | contracts |
| Search alias (Français)  | A French readable name to use in the search url | contrats |
| Last imported on | Optional field for internal use - not required |  |

#### Disabled Tab

| Field                             | Description                                                                     |
| --------------------------------- | ------------------------------------------------------------------------------- |
| Search is disabled                | Yes/No field. Select to replace the Search page with a plain not-available pate |
| Disabled Search Message - English | Message to show on the not-available page                                       |
| Disabled Search Message - French  | French message to show on the not-available page                                |

#### Results

| *Field* | *Description* | *Example Value* |
| --------| ------------- | --------------- |
| No. of Search Results Per Page | Provide a number | 10 |
| Sort-by Categories (English)  | The Solr sort options used on the drop-down page. Separate options with a comma. _DO NOT_ include extra spaces except for the sort order | score desc,start_date desc,owner_org_en asc |
| Sort-by Categories (Français) | The French Solr sort options used on the drop-down page. The English and French fields do not need to match. | score desc,start_date desc,owner_org_fr asc |
| Sort-by Category Labels (English) | The readable labels to show in the drop-down list. _DO NOT_ include extra spaces next to comma | Best Match,Date,Organization |
| Sort-by Category Labels (Français) | The readable French labels to show in the drop-down list | Pertinence,Date,Organisation |
| Default Sort-by Category used when no search terms provided (English)  | Indicate which category to sort by when just browsing the Search results. This should be an exact match for one of the sort categories indicated above. | start_date desc |
| Default Sort-by Category used when no search terms provided (Français) | Indicate which category to sort by when just browsing the Search results. English and French default categories can te tailored to different fields | start_date desc |
| Enable JSON format response | Yes or No. Allows returning Search results as a JSON objects | Default is false |
| Enable raw Solr format response | Yes or No. _DO NOT USE_ in production. For debugging only | Default is false |

#### Templates

The Search application allows the developer to override multiple components of the Search web pages, including the Search page itself.

| *Field* | *Description* | *Example Value* |
| --------| ------------- | --------------- |
| Search Page Template | Django template file to use on the Search page. Can use the default template page or a custom page. | search.html |
| Record Page Template | Django template file to use on the individual Record page. There is a generic default page, but in most cases a custom page is needed. | search_snippets/custom/contracts/contracts_record.html |
| Breadcrumb Snippet Path | Django template snippet to use for the the page breadcrumbs. There is a generic default page, or a custom one can be used. | search_snippets/default_breadcrumb.html |
| Footer Snippet Path | Django template snippet to use for the the page footer. There is generic default snippet or a custom one can be used. | search_snippets/default_footer.html |
| Search Information Message Snippet Path | A template snippet for an message located at the top of every page. Currently not used.  | search_snippets/default_info_message.html |
| About Search Message Snippet Path | A template snippet for the "About this information" message. Template is only displayed if an "About..." message is set in the first tab. There is a default template. | search_snippets/default_about_message.html |
| Custom Javascript for Header file path | A JavaScript file that can be loaded for the custom search page | search_snippets/default_header.js |
| Custom CSS file path | A CSS file that can be loaded for the custom search page | search_snippets/default_header.css |
| Custom Javascript for Body file path | Rarely, used, this is a custom JavaScript file that can be loaded into the body of the file. Field can be left blank. | search_snippets/custom/data/fgp_viewer.js |
| Custom Search Item snippet | A template snippet for the individual search records on the search page. Although there is a default template, almost certainly a custom template will be needed. | search_snippets/custom/contracts/contracts_search_item.html |
| Custom Record snippet  | A template snippet for a whole record on the record page. Although there is a default template, almost certainly a custom template will be needed. Alternatively, the entire individual record page can be replaced with a custom page. | search_snippets/custom/hospitalityq/hospitalityq_record_item.html |
| Custom Record Breadcrumb snippet | A template snippet to use for the the record page breadcrumbs. There is a generic default page, or a custom one can be used. | search_snippets/default_record_breadcrumb.html |
| More-like-This Page Template | The More-like-this template page for this search. There is a default page, or a customized version can be used | more_like_this.html |

#### More Like This ####

| *Field* | *Description* | *Example Value* |
| --------| ------------- | --------------- |
| Enable More-Like-This | By default, most searches disable this functionality | False |
| No. Items returned for More-Like-This  | Number of items to show on the page | 10 |


### 3.2. Add New Fields to the Search ###

Field components describe the individual fields that make up the records that are being loaded into Search.

Each field is associated with a specific Search model. The Field Model UI consists of five tabs.

#### General ####

| *Field* | *Description* | *Example Value* |
| --------| ------------- | --------------- |
| Unique Field Identifier | A code identifier that is unique to this search. |  |
| Search ID | Select the associated Search |  |
| English Label | Default English label |  |
| French Label | Default French label |  |
| Format Name | The format is used to indicate of the field belongs to the primary Search type or another format like Nothing-to-report. Normally this is the same string as the Search ID | contracts or contracts-nil |
| Solr Field Type | Select the solr schema type |  |
| Language | English, French, or Bilingual  |  |
| Copy Field | Create generic Solr copy fields |  |
| Contains Code Values | Indicate if the field has associated Code values |  |
| Extra Solr Copy Fields | Additional copy fields for purposes other export |  |

#### Solr Attributes ####

These choices are associated with Solr field attributes.

| *Field* | *Description* | *Example Value* |
| --------| ------------- | --------------- |
| Stored in Solr | Save value to Solr |  |
| Indexed in Solr | Field is searchable |  |
| Multiple Values | Field has multiple values |  |
| Multi-value Delimiter | Character used to delimit values in the CSV source file |  |
| Monetary Field | Is a monetary field, useful for special formatting |  |

#### Facets ####

These choices apply only if the field is also a filter or facet value.

| *Field* | *Description* | *Example Value* |
| --------| ------------- | --------------- |
| Facet field | Field is facet. Search will automatically generate the facet query |  | |  |
| Custom facet snippet | Select a sort order for the facet items |  |
| Display in reversed order | Display facets items in reversed order. Useful for date-based facets |  |
| Facet order on page | An integer that is used to order facets when there is more than one facet on a page. |  |

#### Advanced ####

Advance properties

| *Field* | *Description* | *Example Value* |
| --------| ------------- | --------------- |
| Alternate record type |  |  |
| Default search item |  |  |
| Default value when empty | Default value to use if the CSV field is empty. Format for this string is <python field type>|<value> | str|- |

#### Search Default ####

Rarely used legacy properties

| *Field* | *Description* | *Example Value* |
| --------| ------------- | --------------- |
| Is default year field |  |  |
| Is default month field |  |  |


### 3.3. Add New Code or Choice values to Fields ###

| *Field* | *Description* | *Example Value* |
| --------| ------------- | --------------- |
| Unique Code ID | Unique code value as it appears in the raw data | tbs-sct |
| Field ID | Select the specific field that uses this code value |  |
| English Code Value/Label | Default English label |  |
| French Code Value/Label | Default French label |  |

#### 3.3.1 Advanced Code settings ####

Rarely used

| *Field* | *Description* | *Example Value* |
| --------| ------------- | --------------- |
| Default Lookup Codes |  |  |
| Conditional Lookup Codes |  |  |
| Date field to evalue |  |  |
| Lookup Date |  |  |
| Lookup Test |  |  |
| Choice lookup code flag |  |  |
| Optional Code value 01 - 05 |  |  |
| Optional English Label 01 - 05 |  |  |
| Optional French Label 01 - 05 |  |  |

## 4. Set up Solr Core schema using the model

To take advantage of the language features of Solr, the search application requires
that the search core use a schema. OCS uses Solr's dynamic schema functionality to
create a custom schema based on the search definition. Once you have finalized the search definition,
run <a href="https://github.com/open-data/oc_search/blob/master/search/management/commands/create_solr_core.py"> `create_solr_core`</a> command line utility.

## 5. Create a code plug-in

In the <a href="https://github.com/open-data/oc_search/tree/master/search/plugins">plugins directory</a> copy the `default.py` file
and rename it to `<search ID>.py`. Note the the file name must exactly match the Search ID. In the plugin file there are a number of
functions that can extended.

## 6. Load Organizational Codes ##

_If you have a Government of Canada department field_ based on the organization's bilingual acronym, wse the `import_orgs_ckan_json` command
to import all of the the government departments into codes. As there over 100 departments and they occasionally change

## 7. Load Search Data ##

Load CSV data into the search core using the <a href="#import_data_csv">import_data_csv</a> command.

## 8. Create custom templates

In the `oc_search/search/templates/snippets/custom` folder, create a new folder the exact same name as your new Search ID.
For example. 'contracts', or 'travelq'. In this folder you will create custom snippets using the Django template language.
Use an existing search for examples of custom snippets for search items, or detailed records.

## 9. Create any extra commands

If you require additional logic, for example for data transformation of the CSV files, sometime is will make sense to
implement this in custom Django management commands that can be run from the command line. This Django commands go into
the folder `oc_search/search/management/commands/` and the files must be names `<search ID>_<command name>.py`

## Advanced Topics

Documentation for these topics will be forthcoming.

- Custom models
- Chronologic Codes
